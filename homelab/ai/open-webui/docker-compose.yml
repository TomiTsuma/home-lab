version: "3.8"

services:
  ollama:
    image: ollama/ollama
    container_name: ollama
    restart: always
    ports:
      - "11434:11434"
    volumes:
      - ollama:/root/.ollama
    # ----------------------------------------------------
    # FIX 1: Ensure Ollama is listening on all interfaces
    # so the Open WebUI container can reliably connect.
    # ----------------------------------------------------
    environment:
      - OLLAMA_HOST=0.0.0.0
    # ----------------------------------------------------
    # NEW: GPU Configuration (NVIDIA/AMD ROCm)
    # Requires NVIDIA Container Toolkit or ROCm on host.
    # ----------------------------------------------------
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    depends_on:
      - ollama
    restart: always
    ports:
      - "8080:8080"
    environment:
      # Correct config for container-to-container communication
      - OLLAMA_HOST=http://ollama:11434
    volumes:
      - open-webui:/app/backend/data

volumes:
  ollama:
  open-webui:


# Install packages to allow apt to use a repository over HTTPS
sudo apt-get update && sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# Add NVIDIA GPG key
curl -fsSL [https://nvidia.github.io/libnvidia-container/gpgkey](https://nvidia.github.io/libnvidia-container/gpgkey) | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg

# Add the repository
distribution=$(. /etc/os-release;echo $ID$VERSION_ID) \
    && curl -s -L [https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list](https://nvidia.github.io/libnvidia-container/$distribution/libnvidia-container.list) | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
